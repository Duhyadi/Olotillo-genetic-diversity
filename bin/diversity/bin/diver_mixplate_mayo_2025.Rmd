---
title: "Genetic diversity for Olotillo Mixplate (plate 1 + plate 2)"
output: html_document
---

# Title: Genetic diversity for Olotillo Mixplate using vcftools. R was used to display the results of vcftools.
# Star date: maybe in August 2023...
# Previous modification: Wed 29/May/2024. Verxoix, Switzerland (20:15 PM) by Duhyadi in cluster CONABIO. 
# Last modification: Fri 20/December/2024. Verxoix, Switzerland  (10:52 AM) on Duhyadi's computer.
# Why Duhyadi's computer? On December 20, 2024. Grillo updates the CONABIO cluster (Mexico) and anything can happen with that cluster... At this point we should not depend on the proper functioning of the cluster.
# Authors: Duhyadi Oliva García & Alicia Mastretta Yanes.
# Path for file in the cluster, vcf filtered: /LUSTRE/Genetica/common/olotillo/olotilloGBS/out60g7/mixplates_filtered_2x.vcf.gz
# Path for file in the cluster, output vcf: /LUSTRE/Genetica/common/olotillo/olotilloGBS/out60g7/mixII.het
# Path for file in Duhyadi's computer, vcf filtered: /home/duhyadi/Documents/paper1/for_Alicia_2024/het_vcf/mixplates_filtered_2x.vcf.gz
# Path for file in Duhyadi's computer, output vcf: /home/duhyadi/Documents/paper1/for_Alicia_2024/het_vcf/mixII.het

--------

# Tutorial for pi and D: https://www.york.ac.uk/res/dasmahapatra/teaching/MBiol_sequence_analysis/workshop4_2019.html

--------
#WAKERHUST lunes 11/08/2025
#todo sea para entregar las correciones al editor y a los revisores 
# tengo que entregar la tabla de los valores por accesion 
# osea los valores de diversidad genetica 
# wkaerhust martes 11 de agosto
--------------------------------------------
--------------------------------------------

## WORKING DIRECTORY 
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/home/duhyadi/Documents/paper1_mayo2025/for_Alicia_2024/het_vcf/" )
```



## LIBRARIES
```{r}
library(doBy)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(readr)
```

## LOAD FILE: generated by vcftools 
```{r}
het <- read.delim("../het_vcf/mixII.het", header = TRUE, sep = "\t", col.names = c("IND", "O(HOM)","E(HOM)","N_SITES", "F"))
```

### Add state to the data frame het 
```{r}
# add state column with pure NA
het$state = NA
# add the state of Campeche
cam_rows <- grep("CAM", het$IND)
het$state[cam_rows] <- "Campeche"
cam_rows
# add the state of Chiapas
chis_rows <- grep("CHIS", het$IND)
het$state[chis_rows] <- "Chiapas"
chis_rows
# no state for GAV which are the evolutionary populations
gav_rows <- grep("GAV", het$IND)
het$state[gav_rows] <- " "
gav_rows
# add the state of Guerrero
gro_rows <- grep("GRO", het$IND)
het$state[gro_rows] <- "Guerrero"
gro_rows
# add the state of Hidalgo
hgo_rows <- grep("HGO", het$IND)
het$state[hgo_rows] <- "Hidalgo"
hgo_rows
# add the state of Nayarit
nay_rows <- grep("NAY", het$IND)
het$state[nay_rows] <- "Nayarit"
nay_rows
# add the state of Oaxaca
oax_rows <- grep("OAX", het$IND)
het$state[oax_rows] <- "Oaxaca"
oax_rows
# add the state of Qintana Roo
roo_rows <- grep("ROO", het$IND)
het$state[roo_rows] <- "Qintana Roo"
roo_rows
# add the state of San Luis Potosí
slp_rows <- grep("SLP", het$IND)
het$state[slp_rows] <- "San Luis Potosi"
slp_rows
# add the state of Veracruz 
ver_rows <- grep("VER", het$IND)
het$state[ver_rows] <- "Veracruz"
ver_rows
# no state for a sample whose labels are unknown
xxx_rows <- grep("XXX", het$IND)
het$state[xxx_rows] <- " "
xxx_rows
```

The file mixxII.het  was obtained by vcftools with the following code: vcftools --gzvcf $mixplates --het --out $out/${project}. The file was mixplates_filtered_2x.vcf.gz
The above script is made in bash, the path of the script is:
/LUSTRE/Genetica/common/olotillo/olotilloGBS/bin/mixplate1_heter_inbre_per_individual.sh

## META FILE
```{r}
# the meta file was obtained from a meta used to perform the PCA, the file was obtained on January 8, 2024
data <- read.csv("pca8ene24_meta_mixplate.csv", sep = ",")
```

### Rename the IND variable in het to sample_name
```{r}
colnames(het)[colnames(het) == "IND"] <- "sample_name"
```

### Join the het data frame with the meta data
```{r}
# join by sample_name
data_merged <- merge(het, data, by = 'sample_name')
# keep only the variables sample_name, accession_ID, scale and Race along with the diversity values
data_merged2 <- merge(het, data[, c('sample_name', "accession_ID", 'scale', 'Race')], by = 'sample_name', all.x = TRUE)
```

### Change inputs scale in data_merged2
```{r}
data_merged2 <- mutate(data_merged2, scale = ifelse(scale == "_L", "Local", scale))
data_merged2 <- mutate(data_merged2, scale = ifelse(scale == "_R", "Regional", scale))
data_merged2 <- mutate(data_merged2, scale = ifelse(scale == "_N", "National", scale))
data_merged2 <- mutate(data_merged2, scale = ifelse(scale == "_E", "Extra", scale))
data_merged2 <- mutate(data_merged2, scale = ifelse(scale == "Extra", "National", scale))
```
But not everything extra is national:
Hugo's Chiapas samples: HUGO PERALES RIVERA CHIAPAS ALTOS 19 OLOTILLO. They appear with National in scale, because they are extra samples, It's good that I remembered! (Duhyadi abr19-24).
In data_merged2 they are in sample_name:
CHIS_E10_1
CHIS_E9_1

### Change to National scale to Regional 
```{r}
data_merged2$scale[data_merged2$sample_name == 'CHIS_E9_1'] <- 'Regional'
data_merged2$scale[data_merged2$sample_name == 'CHIS_E10_1'] <- 'Regional'
```

## Count by Local, Regional and National in Olotillo
```{r}
# filter the data frame for Race "Olotillo"
olotillo_data <- subset(data_merged2, Race == "Olotillo")
# post the unique values in the column 'scale'
olotillo_counts <- table(olotillo_data$scale)
# show results
print(olotillo_counts)
```


--------------------------------------------
--------------------------------------------

## GENETIC DIVERSITY 

###*******************************************###
    **F, INBREEDING COEFFICIENT**
###*******************************************###

### Plot density distribution for F 
```{r}
het_F <- ggplot(data_merged2, aes(F)) + geom_density(fill = "cyan", colour= "black", alpha = 0.3)
het_F + theme_light()
```

### Plot histogram for F 
```{r}
het_F <- ggplot(data_merged2, aes(F)) + geom_histogram(fill = "deeppink2", colour= "black", alpha = 0.3)
 het_F + theme_light()
```

### Summary, F
```{r}
summary(data_merged2$F)
mean(data_merged2$F)
sd(data_merged2$F)
```

### Other path for calculate mean and sd, for F
```{r}
sprintf("Media: %.2f, Desviación Estándar: %.2f", mean(het$F), sd(data_merged2$F))
```

### Summary by race, F ~ Race
```{r}
summary_by_race <- summaryBy(F ~ Race, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Round out by race, F ~ Race
```{r}
# Function to round all numeric columns of summary_by_race to 2 decimal places
round_df <- function(summary_by_race, digits) {
  num_cols <- sapply(summary_by_race, is.numeric) #identify numeric columns
  summary_by_race[num_cols] <- lapply(summary_by_race[num_cols], round, digits = digits) # round numeric columns
  return(summary_by_race)
}
# Apply the function to the summary_by_scale object
summary_by_race_rounded <- round_df(summary_by_race, 2)
```
###{{{}}}}}}}Aquí me quedé, voy al Aldi, creooooo dic17. Debería estar corriendo esto en mi computadora con R, desconexión del cluster  y luego arlequin ...Error en la media, mediana de regional.....revisar Ahhhhhhhh
### Summary by scale, F ~ scale
## martes 12 dw agosto en WAKERHUST
# mas que arlequin conmo lo calculo Irene de Eguiarte con adehgenet y cargar como objeto y te da los valores directos. 
```{r}
Fscale <- summaryBy(F ~ scale, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Summary by accession, F ~ accession_ID
```{r}
# Calculate the average of F for each accession_ID
promedios <- data_merged2 %>%
  group_by(accession_ID) %>%
  summarise(promedio_F = mean(F, na.rm = TRUE))
```



#*********************************************************#
      **OBSERVED NUMBER OF HOMOZYGOUS SITES, O.HOM**
#*********************************************************#

### Plot density distribution for O.HOM.
```{r}
het_O.HOM. <-ggplot(data_merged2, aes(O.HOM.)) + geom_density(fill = "cyan", colour= "black", alpha = 0.3)
het_O.HOM. + theme_light()
```

### Plot histogram for O.HOM
```{r}
het_O.HOM. <-ggplot(data_merged2, aes(O.HOM.)) + geom_histogram(fill = "deeppink2", colour= "black", alpha = 0.3)
het_O.HOM. + theme_light()
```

#*********************************************************#
      **EXPECTED NUMBER OF HOMOZYGOUS SITES, E.HOM**
#*********************************************************#

### Plot density distribution for E.HOM
```{r}
het_E.HOM. <- ggplot(data_merged2, aes(E.HOM.)) + geom_density(fill = "cyan", colour= "black", alpha = 0.3)
het_E.HOM. + theme_light()
```

### Plot histogram for E.HOM
```{r}
het_E.HOM. <- ggplot(data_merged2, aes(E.HOM.)) + geom_histogram(fill = "deeppink2", colour= "black", alpha = 0.3)
het_E.HOM. + theme_light()
```

### Summary, E.HOM
```{r}
summary(data_merged2$E.HOM.)
```

#*********************************************************#
     **OBSERVED NUMBER OF HETEROZYGOUS SITES, O.HET**
#*********************************************************#

## O.HET: observed number of heterozygous sites, is calculated by the following formula;
                
                O(HET) = N_Sites - O(HOM)

## formula as in the article;
                 
            OBs(HET) = Number sites - OBs(HOM)


### Add column O.HET
```{r}
data_merged2$O.HET. <- data_merged2$N_SITES - data_merged2$O.HOM.
```

#*********************************************************#
      **EXPECTED NUMBER OF HETEROZYGOUS SITES, E.HET.**
#*********************************************************#

## E.HET:expected number of heterozygous sites, is calculated by the following formula; 
              
               E(HET) = N_Sites - E(HOM)
               
## formula as in the article;

           EXs(HET) = Number sites - EXs(HOM)

### Add column E.HET
```{r}
data_merged2$E.HET. <- data_merged2$N_SITES - data_merged2$E.HOM.
```

#*********************************************************#
      **PROPORTION OBSERVED HETEROZYGOUS SITES**
              **HETEROCIGOSIS OBSERVADA**
                      **HeOB**
#*********************************************************#

## Proportion Observed Heterozygous Sites, HETob;

              HETob = O(HET) / N_Sites

## formula as in the article, the observed heterozygosity value was calculated with; 

            HEOB = OBs(HET) / Number sites

### Add column HETob
```{r}
data_merged2$HETob <- data_merged2$O.HET. / data_merged2$N_SITES
```

### Summary, HETob 
```{r}
summary(data_merged2$HETob)
mean(data_merged2$HETob)
sd(data_merged2$HETob)
```

### Other path for calculate mean and sd, HETob
```{r}
sprintf("Media: %.2f, Desviación Estándar: %.2f", mean(data_merged2$HETob), sd(data_merged2$HETob))
```

### Summary by Race, HETob ~ Race
```{r}
summary_by_race <- summaryBy(HETob ~ Race, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Round out by race, HETob ~ Race
```{r}
# Function to round all numeric columns of summary_by_race to 2 decimal places
round_df <- function(summary_by_race, digits) {
  num_cols <- sapply(summary_by_race, is.numeric) #identify numeric columns
  summary_by_race[num_cols] <- lapply(summary_by_race[num_cols], round, digits = digits) # round numeric columns
  return(summary_by_race)
}
# Apply the function to the summary_by_scale object
summary_by_race_rounded <- round_df(summary_by_race, 2)
```

### Summary by scale, HETob ~ scale
```{r}
summary_by_scale <- summaryBy(HETob ~ scale, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Summary by state, HETob ~ state
```{r}
summary_by_state <- aggregate(HETob ~ state,data_merged2 , summary)
```

### Plot density distribution for HETob
```{r}
het_HETob <- ggplot(data_merged2, aes(HETob)) + geom_density(fill = "orange", colour= "black", alpha = 0.3)
het_HETob + theme_light()
```

#*********************************************************#
      **PROPORTION EXPECTED HETEROZYGOUS SITES**
             **HETEROCIGOSIS ESPERADA**
                       **HeEX**
#*********************************************************#

## Proportion Expected Heterozygous Sites, HETex;

            HETex = E(HET) / N_Sites

## formula as in the article, the expected heterozygosity value was calculated with;

            HEEX = EXs(HET) / Number sites

### Add column HETex
```{r}
data_merged2$HETex <- data_merged2$E.HET. / data_merged2$N_SITES
```

### Summary, HETex
```{r}
summary(data_merged2$HETex)
mean(data_merged2$HETex)
sd(data_merged2$HETex)
```

### Other path for calculate mean and sd, HETex
```{r}
sprintf("Media: %.2f, Desviación Estándar: %.2f", mean(data_merged2$HETex), sd(data_merged2$HETex))
```

### Plot density distribution for HETex
```{r}
HETex <-ggplot(data_merged2, aes(HETex)) + geom_density(fill = "orange", colour= "black", alpha = 0.3)
HETex + theme_light()
```

### Summary by Race, HETex ~ Race
```{r}
summary_by_race <- summaryBy(HETex ~ Race, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Round out by race, HETex ~ Race
```{r}
# Function to round all numeric columns of summary_by_race to 2 decimal places
round_df <- function(summary_by_race, digits) {
  num_cols <- sapply(summary_by_race, is.numeric) #identify numeric columns
  summary_by_race[num_cols] <- lapply(summary_by_race[num_cols], round, digits = digits) # round numeric columns
  return(summary_by_race)
}
# Apply the function to the summary_by_scale object
summary_by_race_rounded <- round_df(summary_by_race, 2)
```

### Summary by scale, HETex ~ scale
```{r}
summary_by_scale <- summaryBy(HETex ~ scale, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Summary by state for HETex, HETex ~ state 
```{r}
summary_by_state <- aggregate(HETex ~ state,data_merged2, summary)
```

#*********************************************************#
      **PROPORTION EXPECTED HOMOZYGOUS SITES**
            **HOMOCIGOSIS ESPERADA**
                    **HoEX**
#*********************************************************#

## Proportion Expected Homozygoys Sites, HOMex;

            HOMex = 1 - HETex

## formula as in the article, the expected homozygous value was calculated with;

          HOEX = 1 - HEEX (HET)
          
### Add column HOMex
```{r}
data_merged2$HOMex <- 1 - data_merged2$HETex
```

## WAKERHUST 12 DE AGOSTO DEL 2025
## HASTA AQUI PUEDO ESTAR SEGURA DE OBETENER EL CSV DE LOS DATOS DE DIVERSIDAD, POR LO QUE PODRIA CORRER TODO LO ANTERIOR SIN PROBLEMA  YA SE PARA TODAS LA VARIABLES DE DIVERSIDAD DE DATAMERGED2 O INCLUSO CON LOS PLOTS DE DISTRIBUCION 
```{r}
# convertir data_merged2 a csv 
write.csv(data_merged2, "data_diversity_ago2025", row.names = FALSE)
```


### Summary, HOMex
```{r}
summary(data_merged2$HOMex)
mean(data_merged2$HOMex)
sd(data_merged2$HOMex)
```

### Other path for calculate mean and sd, HOMex  
```{r}
sprintf("Media: %.2f, Desviación Estándar: %.2f", mean(data_merged2$HOMex), sd(data_merged2$HOMex))
```

### Plot density distribution for HOMex
```{r}
HOMex <-ggplot(data_merged2, aes(HOMex)) + geom_density(fill = "orange", colour= "black", alpha = 0.3)
HOMex + theme_light()
```

### Summary by Race, HOMex ~ Race 
```{r}
summary_by_race <- summaryBy(HOMex ~ Race, data=data_merged2, FUN=c(mean, median, sd, min, max))
```
 
### Round out by race, HOMex ~ Race
```{r}
# Function to round all numeric columns of summary_by_race to 2 decimal places
round_df <- function(summary_by_race, digits) {
  num_cols <- sapply(summary_by_race, is.numeric) #identify numeric columns
  summary_by_race[num_cols] <- lapply(summary_by_race[num_cols], round, digits = digits) # round numeric columns
  return(summary_by_race)
}
# Apply the function to the summary_by_scale object
summary_by_race_rounded <- round_df(summary_by_race, 2)
```

### Summary by scale, HOMex ~ scale
```{r}
summary_by_scale <- summaryBy(HOMex ~ scale, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Summary by state for HETex, HOMex  ~ state 
```{r}
summary_by_state <- aggregate(HOMex ~ state,data_merged2, summary)
```


#*********************************************************#
                       **N_SITES**
#*********************************************************#

### Summary, N_SITES
```{r}
summary(data_merged2$N_SITES)
mean(data_merged2$N_SITES)
sd(data_merged2$N_SITES)
```

### Other path for calculate mean and sd for N_SITES  
```{r}
sprintf("Media: %.2f, Desviación Estándar: %.2f", mean(data_merged2$N_SITES), sd(data_merged2$N_SITES))
```

### Summary by Race, N_SITES ~ Race 
```{r}
summary_by_race <- summaryBy(N_SITES ~ Race, data=data_merged2, FUN=c(mean, median, sd, min, max))
```

### Summary by scale, N_SITES ~ scale
```{r}
summary_by_scale <- summaryBy(N_SITES ~ scale, data=data_merged2, FUN=c(mean, median, sd, min, max))
```


#*********************************************************#
                         **pi**
#*********************************************************#

## pi.all
```{r}
pi.all <- read.table("mixII_all_samples_10kb.windowed.pi",header=T)
```

The file mixxII_all_samples_10kb.windowed.pi was obtained by vcftools with the following code: vcftools --gzvcf $mixplates --window-pi 10000 --out $out/${project}_all_samples_10kb

## pi by races 
```{r}
# pi Olotillo
pi.olotillo <- read.table("mixII_all_samples_10kb_olotillo.windowed.pi",header=T)
# pi Tuxpeño
pi.tuxpeño <- read.table("mixII_all_samples_10kb_tuxpeño.windowed.pi",header=T)
# pi Dzit-bacal
pi.dzitbacal <- read.table("mixII_all_samples_10kb_dzitbacal.windowed.pi",header=T)
# pi Mix
pi.mix <- read.table("mixII_all_samples_10kb_mix.windowed.pi",header=T)
```

### Plot density distribution for pi.all
```{r}
pi <-ggplot(pi.all, aes(PI)) + geom_density(fill = "cyan", colour= "black", alpha = 0.3)
pi + theme_light()
```

### Hist, pi.all
```{r}
hist(pi.all$PI,br=20)
```

### Summary, pi.all
```{r}
summary(pi.all$PI)
mean(pi.all$PI)
sd(pi.all$PI)
```
### Summary, by races
### Olotillo
```{r}
summary(pi.olotillo$PI)
mean(pi.olotillo$PI)
sd(pi.olotillo$PI)
```

### Tuxpeño
```{r}
summary(pi.tuxpeño$PI)
mean(pi.tuxpeño$PI)
sd(pi.tuxpeño$PI)
```

### Dzit-bacal
```{r}
summary(pi.dzitbacal$PI)
mean(pi.dzitbacal$PI)
sd(pi.dzitbacal$PI)
```

### Mix 
```{r}
summary(pi.mix$PI)
mean(pi.mix$PI)
sd(pi.mix$PI)
```

## pi by scales  
```{r}
# pi local
pi.local <- read.table("mixII_all_samples_10kb_local.windowed.pi",header=T)
# pi regional
pi.regional <- read.table("mixII_all_samples_10kb_regional.windowed.pi",header=T)
# pi Dzit-bacal
pi.national <- read.table("mixII_all_samples_10kb_national.windowed.pi",header=T)
```

### local 
```{r}
summary(pi.local$PI)
mean(pi.local$PI)
sd(pi.local$PI)
```

### regional 
```{r}
summary(pi.regional$PI)
mean(pi.regional$PI)
sd(pi.regional$PI)
```

### national
```{r}
summary(pi.national$PI)
mean(pi.national$PI)
sd(pi.national$PI)
```


### Other path for calculate mean and sd, pi.all
```{r}
sprintf("Media: %.2f, Desviación Estándar: %.2f", mean(pi.all$PI), sd(pi.all$PI))
```

### Boxplot, pi.all
```{r}
boxplot(pi.all$PI,ylab="diversity")
```

### Chr10, pi.all
```{r}
pi.chr10 <- subset(pi.all, CHROM == "chr10")
```

### Summary, pi chr10
```{r}
summary(pi.chr10)
summary(pi.all)
```

### Summary, pi.all and chr10
```{r}
# pi.all
summary(pi.all$PI)
mean(pi.all$PI)
sd(pi.all$PI)
# pi.chr10
summary(pi.chr10$PI)
mean(pi.chr10$PI)
sd(pi.chr10$PI)
```

### Plot X?
```{r}
plot(pi.chr10$BIN_START,pi.chr10$PI,xlab="position",ylab="diversity")
```

#*********************************************************#
                         **Tajima’s D**
#*********************************************************#



## Plotting Tajima’s D

```{r}
taj.all <- read.table("mixII_all_samples_10kb.Tajima.D",header=T)
```


```{r}
taj <-ggplot(taj.all, aes(TajimaD)) + geom_density(fill = "purple", colour= "black", alpha = 0.3)
taj + theme_light()
```

### D by races 
```{r}
# D Dzit-bacal
taj.dzitbacal <- read.table("mixII_all_samples_10kb_dzitbacal.Tajima.D",header=T)
# D Mix
taj.mix <- read.table("mixII_all_samples_10kb_mix.Tajima.D",header=T)
# D olotillo 
taj.olotillo <- read.table("mixII_all_samples_10kb_olotillo.Tajima.D",header=T)
# D Tuxpeño
taj.tuxpeño <- read.table("mixII_all_samples_10kb_tuxpeño.Tajima.D",header=T)
```

### Summary all
```{r}
summary(taj.all$TajimaD)
```

### D Dzit-bacal
```{r}
summary(taj.dzitbacal$TajimaD)
```

### Mix 
```{r}
summary(taj.mix$TajimaD)
```

### Olotillo
```{r}
summary(taj.olotillo$TajimaD)
```

### Tuxpeño
```{r}
summary(taj.tuxpeño$TajimaD)
```

```{r}
sprintf("mean: %.2f, Desviación Estándar: %.2f", mean(taj.all$TajimaD), sd(pi.all$TajimaD))
```

### D by scale
```{r}
# D local
taj.local <- read.table("mixII_all_samples_10kb_local.Tajima.D",header=T)
# D regional
taj.regional <- read.table("mixII_all_samples_10kb_regional.Tajima.D",header=T)
# D national
taj.national <- read.table("mixII_all_samples_10kb_national.Tajima.D",header=T)
```

### local
```{r}
summary(taj.local$TajimaD)
```

### regional
```{r}
summary(taj.regional$TajimaD)
```

### national
```{r}
summary(taj.national$TajimaD)
```


```{r}
hist(taj.all$TajimaD,br=20)
```

```{r}
taj.chr10 <- subset(taj.all, CHROM == "chr10")
```


```{r}
plot(taj.chr10$BIN_START,taj.chr10$TajimaD,xlab="position",ylab="Tajima's D")
```
### dic 10/24
### download data_merged2 for statistical analysis
```{r}
getwd()
```

```{r}
write.csv(data_merged2, "data_merged2", row.names = FALSE)
```


```{r}
version
```


