---
title: "Olotillo_map"
output: html_document
---

# Title: Plot map with maptools, rgeos and rgdal.
# Star date: October 2023 by Alicia Mastretta-Yanes.
# Previous modification: Fri 10/Oct/2025. Versoix, Switzerland (16:28) by Duhyadi Oliva-Garc√≠a
# Last modification: Mon 13/Oct/2025. Versoix, Switzerland (14:03) by Duhyadi Oliva-Garc√≠a.
# Authors: Duhyadi Oliva-Garc√≠a & Alicia Mastretta-Yanes.

------------------------------------------------------------------------

# INITIAL PROJECT SETUP  
```{r setup, include=FALSE}
# --- Load the package here (for reproducible routes) ----------------------------------------
if (requireNamespace("here", quietly = TRUE)) {
  setwd(here::here())
  message("üìÇ  Working directory set to: ", getwd())
} else {
  stop("‚ö†Ô∏è The 'here' package is not installed. Execute install.packages('here')")
}
```

------------------------------------------------------------------------

# LOAD LIBRARIES
```{r}
library(dplyr)
library(ggplot2)
# library(gpclib) # officially retired from CRAN in 2023, replace with sf
# library(maptools) # like gpclib, the maptools package was removed from CRAN in 2023, replace with sf
# library(rgeos) # in the process of retirement, replace with sf 
#library(rgdal) # was also officially retired from CRAN in 2023 (along with rgeos and maptools, replace with sf 
library(sf)
```
Note #1: gpclib and maptools are no longer used; most of their functions have been migrated to other, more modern packages ‚Äî primarily sf, sp, and rgeos (although rgeos is also in the process of being retired).

# LOAD DATA: read shape and points
```{r}
# --- Load spatial layers and data -----------------------------------------
mexico <- st_read(here::here("shape","destdv1gw" ,"destdv1gw.shp")) # Mexico shape
distribution <- st_read(here::here("shape","oloti_7cgw" ,"oloti_7cgw.shp")) # Olotillo distribution shape
olotillo.PGMN <- read.csv(here::here("meta","olotillo_PGMN_siagro.csv")) # Olotillo, Proyecto Global Ma√≠ces Nativos (PGMN)
olotillo.points <- read.csv(here::here("meta", "olotillo_points_meta_clean.csv")) # Olotillo, Proyecto Doctoral Poblaciones Evolutivas
```
Note #2: here::here. It's the safe way to call package here.
Occurrence points for Olotillo, were collected in the field for, 2018-2019 : Duhyadi Oliva-Garc√≠a(Chiapas), Alicia Mastretta-Yanes(Chiapas), Bulmaro Couti√±o-Estrada (Chiapas), Flavio Arag√≥n-Cuevas (Oaxaca), No√© Orlando-G√≥mez (Guerrero), V√≠ctor Antonio Vidal Mart√≠nez (Nayarit) and Hugo Perales-Rivera (Chiapas-different year). Also include samples from CIMMYTM.

# PLOT
## MAP #1 
## ------------------------------------------------------------------
## üó∫Ô∏è Base map of Mexico with distribution...
## ------------------------------------------------------------------
Distribution of olotillo according to Perales & Golicher (2014) + points for olotillo, from the Global Maize Project (CONABIO, 2011) + accessions sampled for this study by race.
```{r}
# --- Create the map -----------------------------------------
map1 <- ggplot() +
  geom_sf(data = mexico, colour = "grey", fill = NA) + # shape mexico
  geom_sf(data = distribution, colour = "blue", fill = NA, size = 0.2) + # shape distribution
  geom_point(data = olotillo.PGMN, aes(x = longitud, y = latitud), size = 0.5, colour = "black") +
  geom_point(data = olotillo.points, aes(x = longitude, y = latitude, shape = Race, color = Race), size = 1.5) +
  scale_shape_manual(values = c(15, 17, 16, 18)) +
  scale_color_manual(values = c("purple", "green", "red", "orange")) +
  theme_void()
# --- Show map -----------------------------------------
map1
```

## MAP #2
## ------------------------------------------------------------------
## üó∫Ô∏è Base map of Mexico with distribution and points of PGMN (Olotillo)
## ------------------------------------------------------------------
Climatic interpolation of Olotillo distribution according to Perales & Golicher (2014) + sampling points for Olotillo from the Global Maize Project (CONABIO, 2011). 
**Figure 1.Distribution and environmental conditions where Olotillo is grown.** 
**a)** Purple color shows the climatic interpolation of Olotillo distribution, restricted to the main altitude where it is grown, according to Perales & Golicher (2014). Black points are the sampling points of Olotillo from the Global Maize Project (GMP: CONABIO, 2011).
```{r}
# --- Create the map -----------------------------------------
map2 <- ggplot() +
  geom_sf(data = mexico, colour = "grey", fill = NA, linewidth = 0.3) + # base polygon of Mexico
  geom_sf(data = distribution, colour = "purple", fill = NA, linewidth = 0.6) + # distribution polygon 
  geom_point(                          # points of PGMN
    data = olotillo.PGMN,
    aes(x = longitud, y = latitud),
    colour = "black",
    size = 0.8
  ) + 
  theme_void()                        # general style of the map 
# --- Show map -----------------------------------------
map2
```

## MAP #3
## ------------------------------------------------------------------
## üó∫Ô∏è Map of Mexico highligthing states that were sampled (same colors than PCA)
## ------------------------------------------------------------------
```{r}
# --- Color by states -----------------------------------------
mexico_sf <- st_as_sf(mexico, region = "ENTIDAD")
lapply(mexico_sf, class)
print(mexico_sf)
```
### Convert shape to data frame: extract coordinates and attributes in data.frame format
```{r}
# ---- Extract coordinates and correctly join them with the attributes ---------------------
coords <- st_coordinates(mexico) %>% as.data.frame()
coords$ID <- as.numeric(rownames(coords))   # create temporary ID
# ---- Convert geometries to data.frame (maintaining attributes) ---------------------------
mexico_df <- mexico %>%
  st_drop_geometry() %>%                    # delete geometry (maintains attributes)
  mutate(ID = row_number()) %>%             # create reference ID
  right_join(coords, by = "ID")             # join with coordinates

                                                                
head(mexico_df)                             # check result 
```
### Pop data
```{r}
# --- Read the file plate1_fullmeta.txt -----------------------------------------
pop.data <- read.table(
  here::here("meta", "plate1_fullmeta.txt"),
  sep = "\t",
  header = TRUE,
  stringsAsFactors = FALSE
)
pop.data <- pop.data[order(pop.data$sample_name),]  # order alphabetically pop.data
pop.data <- pop.data[-1,]                           # remove the first element, (DNA BLANK)
dim(pop.data)                                       # check n samples
```

```{r}
# make vector of states excluding where we sampled olotillos
sampled.states<-unique(pop.data$state)
sampled.states
```

```{r}
# to get a names in the data frame
unique(mexico_sf$ENTIDAD) # logica Duhyadi jun 2024
# change to they way 
sampled.states<-c("CAMPECHE", "CHIAPAS", "GUERRERO", "HIDALGO",
                  "NAYARIT", "OAXACA", "QUINTANA ROO", "SAN LUIS POTOSI",
                  "VERACRUZ DE IGNACIO DE LA LLAVE")

# not.sampled<-unique(mexico_sf$id)[!unique(mexico_sf$id) %in% sampled.states] # code original Alicia

not.sampled<-unique(mexico_sf$ENTIDAD)[!unique(mexico_sf$ENTIDAD) %in% sampled.states] #logica Duhyadi jun 2024  
  
## Map showing only sampled states

map2 <- ggplot()  +
       geom_polygon(data = mexico_sf, 
                    aes(x = long, y = lat, group = group, fill =ENTIDAD ), #fill =id ),
                    colour = "grey") + theme_void() +
                    theme(legend.position="none") +
                    scale_fill_manual(breaks = c(sampled.states, not.sampled),
                                      values = c("grey60", # 9 color-blind friendly cols
                                                "#75a842",
                                                "#36dee6",
                                                "#52bd85",
                                                "#b94656",
                                                "#6780d8",
                                                "#c69c39",
                                                "#b6b638",
                                                "#89863c",
                                                # the rest leave blank
                                                rep("white", 23)))

map2 
```


```{r}
# --- Map showing only sampled states -----------------------------------------
map2 <- ggplot() +
  geom_sf(
    data = mexico_sf,
    aes(fill = ENTIDAD),
    colour = "grey40",
    linewidth = 0.3
  ) +
  theme_void() +
  theme(legend.position = "none") +
  scale_fill_manual(
    breaks = c(sampled.states, not.sampled),
    values = c(
      "grey60",     # base
      "#75a842",    # verde
      "#36dee6",    # turquesa
      "#52bd85",    # verde medio
      "#b94656",    # rojo
      "#6780d8",    # azul
      "#c69c39",    # dorado
      "#b6b638",    # oliva
      "#89863c",    # marr√≥n verdoso
      rep("white", 23)
    )
  ) 

map2

```


# Add sampling points of Olotillo from PGMN

```{r}
map3 <- ggplot() + 
        geom_polygon(data = mexico_df, show.legend=FALSE,
              aes(x = long, y = lat, group = group, fill =id ), 
              colour = "grey") + 
              # theme(legend.position="none") +
              scale_fill_manual(breaks = c(sampled.states, not.sampled),
                                values = c("grey60", # 9 color-blind friendly cols
                                          "#75a842",
                                          "#36dee6",
                                          "#52bd85",
                                          "#b94656",
                                          "#6780d8",
                                          "#c69c39",
                                          "#b6b638",
                                          "#89863c",
                                          # the rest leave blank
                                          rep("white", 23))) + theme_void()
#shape file for siagro and olotillo points  
map3 + geom_point(data = olotillo.PGMN,
                 size=0.4, colour = "black",
                 aes(x=longitud, y=latitud)) +
        geom_polygon(data = distribution, size=0.1,
                    aes(x = long, y = lat, group = group), 
                    colour = "pink", fill = NA) + 
  geom_point(data = olotillo.points, size=1.5,
           aes(x = longitude, y = latitude, shape= Race, color= Race)) +
  scale_shape_manual(values = c(15, 17, 16, 18)) +
  scale_color_manual(values = c("purple", "green", "blue", "yellow"))  +
  theme()
```

########29Dic2023#######################################################

```{r}
map3 <- ggplot() + 
        geom_polygon(data = mexico_df, show.legend=FALSE,
              aes(x = long, y = lat, group = group, fill =id ), 
              colour = "grey") + 
              # theme(legend.position="none") +
              scale_fill_manual(breaks = c(sampled.states, not.sampled),
                                values = c("grey60", # 9 color-blind friendly cols
                                          "#75a842",
                                          "#36dee6",
                                          "#52bd85",
                                          "#b94656",
                                          "#6780d8",
                                          "#c69c39",
                                          "#b6b638",
                                          "#89863c",
                                          # the rest leave blank
                                          rep("white", 23))) + theme_void()
#shape file for siagro and olotillo points  
map3 + geom_point(data = olotillo.PGMN,
                 size=0.4, colour = "black",
                 aes(x=longitud, y=latitud)) + 
  geom_point(data = olotillo.points, size=1.5,
           aes(x = longitude, y = latitude, shape= Race, color= Race)) +
  scale_shape_manual(values = c(15, 17, 16, 18)) +
  scale_color_manual(values = c("purple", "green", "blue", "yellow"))  +
  theme()
```

```{r}
map + geom_point(data = olotillo.points, size = 1,
           aes(x = longitude, y = latitude, shape= Race, color= Race)) 
```

```{r}
olotillo.points$Race
```
